name: Deploy to Elastic Beanstalk

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install dependencies
              run: npm install

            - name: Build project
              run: npm run build

            - name: Prepare deploy package
              run: |
                  mkdir deploy
                  cp -r .next public package.json next.config.mjs deploy/
                  # Procfile과 .ebextensions 폴더 복사 (존재하는 경우)
                  if [ -f Procfile ]; then cp Procfile deploy/; fi
                  if [ -f .npmrc ]; then cp .npmrc deploy/; fi
                  if [ -d .ebextensions ]; then cp -r .ebextensions deploy/; fi
                  cd deploy
                  zip -r ../weplan-app-deploy.zip ./
                  cd ..

            - name: Upload to S3
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: 'ap-northeast-2'
                  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
              run: |
                  aws s3 cp weplan-app-deploy.zip s3://elasticbeanstalk-ap-northeast-2-${AWS_ACCOUNT_ID}/weplan-app/weplan-app-deploy-${{ github.run_number }}.zip

            - name: Deploy to Elastic Beanstalk
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: 'ap-northeast-2'
                  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
              run: |
                  aws elasticbeanstalk create-application-version \
                    --application-name weplan-app \
                    --version-label ${{ github.run_number }} \
                    --source-bundle "{\"S3Bucket\":\"elasticbeanstalk-ap-northeast-2-${AWS_ACCOUNT_ID}\",\"S3Key\":\"weplan-app/weplan-app-deploy-${{ github.run_number }}.zip\"}"

                  aws elasticbeanstalk update-environment \
                    --application-name weplan-app \
                    --environment-name weplan-env \
                    --version-label ${{ github.run_number }}
